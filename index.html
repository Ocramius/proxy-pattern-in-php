<!doctype html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="utf-8" />
    <title>OOP Proxies in PHP</title>
    <meta name="description" content="The Proxy OOP Pattern in PHP: how to use it and how to know when we need it" />
    <meta name="author" content="Marco Pivetta" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="bower_components/reveal.js/css/reveal.min.css">
    <link rel="stylesheet" href="bower_components/reveal.js/css/theme/default.css" id="theme">
    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="bower_components/reveal.js/lib/css/zenburn.css" id="highlight-theme">
    <!-- If the query includes 'print-pdf', use the PDF print sheet -->
    <script>
        document.write( '<link rel="stylesheet" href="bower_components/reveal.js/css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
    </script>
    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="assets/style.css" />

    <style type="text/css">
        /* overrides */
        /*body {
            background: #040E27;
            background: -moz-radial-gradient(center, circle cover, #555a5f 0%, #040E27 100%);
            background: -webkit-gradient(radial, center center, 0px, center center, 100%, color-stop(0%, #555a5f), color-stop(100%, #040E27));
            background: -webkit-radial-gradient(center, circle cover, #555a5f 0%, #040E27 100%);
            background: -o-radial-gradient(center, circle cover, #555a5f 0%, #040E27 100%);
            background: -ms-radial-gradient(center, circle cover, #555a5f 0%, #040E27 100%);
            background: radial-gradient(center, circle cover, #555a5f 0%, #040E27 100%);
            background-color: #040E27;
        }*/

        .zf-color {
            color: #68B604;
        }

        .doctrine-color {
            color: #FC6A31;
        }

        .doctrine-bg {
            background-color: #040E27;
        }

        .reveal section img {
            border: 0;
            background: none;
            box-shadow: 0 0 #000;
        }

        .reveal pre {
            width: 100%;
            font-size: 0.68em;
        }

        .reveal pre code {
            max-height: 600px;
        }
    </style>
</head>
<body>
<div class="reveal">
<div class="slides">

<section style="visibility:hidden;"></section>
<section>
    <h1>
        Hello!
    </h1>
</section>
<section>
    <h2>
        <img src="assets/img/ocramius.gif" alt="Marco Pivetta" style="height: 70px; margin: 0;"/>
        <a href="http://ocramius.github.com/" target="_blank">Marco Pivetta</a>
    </h2>
</section>
<section>
    <h2>
        <img src="assets/img/ocramius.gif" alt="Marco Pivetta" style="height: 70px; margin: 0;"/>
        <a href="http://ocramius.github.com/" target="_blank">Ocramius</a>
    </h2>
</section>
<section>
    <img src="assets/img/roave-logo.png" alt="Roave"/>
    <p class="fragment">
        <a href="https://github.com/EvanDotPro">
            <img src="http://www.gravatar.com/avatar/3fb997938a45ac4ea89a90164931368d?s=70&d=mm&r=g" alt="Evan Coury (EvanDotPro)"/>
        </a>
        <a href="https://github.com/TheFrozenFire">
            <img src="http://www.gravatar.com/avatar/f9c4bcbe0990d74fbf2043602ec1a60d?s=70&d=mm&r=g" alt="Justin Martin (FrozenFire)"/>
        </a>
        <a href="https://github.com/DASPRiD">
            <img src="http://www.gravatar.com/avatar/c9e618a09b7a872be9376b099b688eda?s=70&d=mm&r=g" alt="Ben Scholzen (DASPRiD)"/>
        </a>
        <a href="https://github.com/Ocramius">
            <img src="http://www.gravatar.com/avatar/879d7c8ea365a31443e6b890f68a7d7d?s=70&d=mm&r=g" alt="Marco Pivetta (Ocramius)"/>
        </a>
        <a href="https://github.com/Akrabat">
            <img src="http://www.gravatar.com/avatar/10e8bec5942c84bf30bcb5af7494f44a?s=70&d=mm&r=g" alt="Rob Allen (Akrabat), Nineteen Feet)"/>
        </a>
        <a href="https://github.com/nclundsten">
            <img src="http://www.gravatar.com/avatar/816760c449322bb88a02cea027c857ab?s=70&d=mm&r=g" alt="Nigel Lundsten (nlundsten)"/>
        </a>
        <a href="https://github.com/Xerkus">
            <img src="http://www.gravatar.com/avatar/4f7157a6ccf330bc161b126da934cefe?s=70&d=mm&r=g" alt="Aleksey Khudyakov (Xerkus)"/>
        </a>
        <a href="https://github.com/Spabby">
            <img src="http://www.gravatar.com/avatar/e61ae7dfad370ba47a72f79418160f51?s=70&d=mm&r=g" alt="Gary Hockin (Spabby / GeeH)"/>
        </a>
        <img src="http://www.gravatar.com/avatar/8b228094f53356cb826741cc40a01cd6?s=70&d=mm&r=g" alt="Priscilla Hubbard"/>
        <img src="http://www.gravatar.com/avatar/44e4328250ce6d98d5384c3c1fcd0274?s=70&d=mm&r=g" alt="Chloe"/>
    </p>
    <p class="fragment">
        <marquee>We're awesome!</marquee>
    </p>
    <p class="fragment">(And we love &lt;marquee/&gt;)</p>
</section>
<section>
    <h2>Awesome:</h2>
    <img src="assets/img/awesome-moose.gif" alt="Definition of Awesome" style="width: 100%"/>
</section>
<section>
    <h2>
        <img
            src="assets/img/doctrine.svg"
            alt="Doctrine Project" border="0"
            height="100px"
            style="margin: -13px;"
        />
        <span class="doctrine-color">octrine</span> team
    </h2>
</section>
<section>
    <h2>
        <img
            src="assets/img/zf-logo.svg"
            alt="Zend Framework 2"
            width="150px"
            style="margin: -8px;"
        />
        contributor
    </h2>
</section>
<section>
    <h2>
        <img
            src="assets/img/gh.svg"
            alt="Ocramius on Github"
            height="70px"
            style="margin: 0;"
        />
        <img
            src="assets/img/twitter.svg"
            alt="Ocramius on Twitter"
            height="70px"
            style="margin: 0;"
        />
        <a href="http://twitter.com/Ocramius" target="_blank">Ocramius</a>
    </h2>
</section>

<section>
    <section>
        <h2>Current projects</h2>
        <p>
            <a target="_blank" href="https://github.com/Ocramius/ProxyManager">ProxyManager</a>,
            <a target="_blank" href="https://github.com/bjyoungblood/BjyAuthorize">BjyAuthorize</a>,
            <a target="_blank" href="https://github.com/RWOverdijk/AssetManager">AssetManager</a>,
            <a target="_blank" href="https://github.com/BinaryKitten/ZeffMu">ZeffMu</a>,
            <a target="_blank" href="https://github.com/zf-fr/ZfrRest">ZfrRest</a>,
            <a target="_blank" href="https://github.com/Ocramius/OcraDiCompiler">OcraDiCompiler</a>,
            <a target="_blank" href="https://github.com/Ocramius/OcraServiceManager">OcraServiceManager</a>,
            <a target="_blank" href="https://github.com/Ocramius/OcraCachedViewResolver">OcraCachedViewResolver</a>,
            <a target="_blank" href="https://github.com/doctrine/DoctrineModule">DoctrineModule</a>,
            <a target="_blank" href="https://github.com/doctrine/DoctrineORMModule">DoctrineORMModule</a>,
            <a target="_blank" href="https://github.com/doctrine/DoctrineMongoODMModule">DoctrineMongoODMModule</a>,
            <a target="_blank" href="https://github.com/Ocramius/VersionEyeModule">VersionEyeModule</a>
        </p>
    </section>
</section>
<section>
    <h1>WHY?</h1>
</section>
<section>
    <img src="assets/img/for-the-glory-of-satan.jpg" alt="For the glory of satan, of course!" style="width: 60%"/>
</section>

<section>
    <h1>
        The <span class="proxy-color">Proxy Pattern</span>
        <br/>
        in <span class="php-color" style="font-size: 120%;">PHP</span>
    </h1>
</section>

<section>
    <h2>What is a <span class="proxy-color">Proxy</span>?</h2>
</section>
<section>
    <p>
        A <span class="proxy-color">proxy</span>
        is a class functioning as an interface to
        <span class="php-color">something else</span>
    </p>

    <p class="fragment" style="font-size: small;">(carefully pasted from wikipedia)</p>
</section>
<section>
    <h1>Simple put</h1>
</section>
<section>
    <img src="assets/img/deer.png" alt="Deer" style="width: 100%"/>
</section>
<section>
    <img src="assets/img/nope.png" alt="Nope" style="width: 100%"/>
</section>
<section>
    <img src="assets/img/chuck-testa.png" alt="Chuck Testa!" style="width: 100%"/>
</section>


<section>
    <h2>A <span class="proxy-color">Proxy</span> implements a <span class="php-color">Subject</span>'s interface</h2>
</section>
<section>
    <p>
        A <span class="proxy-color">proxy</span> replaces
        <span class="php-color">subject</span> thanks to the
        <a href="http://en.wikipedia.org/wiki/Liskov_substitution_principle" target=_blank>
            <abbr title="Liskov Substitution Principle">LSP</abbr>
        </a>
    </p>
</section>

<section data-state="soothe">
    <img
        alt="A Proxy implements the same interface as of a real subject"
        src="http://yuml.me/diagram/dir:TB;scale:180;/class/[<<SubjectInterface>>]^-.-implements [RealSubject{bg:blue}], [<<SubjectInterface>>]^-.-implements [SubjectProxy{bg:orange}].svg"
        style="width: 100%;"
    />
</section>
<section>
    <h2><span class="zf-color">Client</span> consumes <span class="php-color">SubjectInterface</span></h2>
</section>

<section data-state="soothe">
    <img
        alt="A Client uses the SubjectInterface"
        src="http://yuml.me/diagram/dir:TB;scale:180;/class/[<<SubjectInterface>>]<-.-consumes [Client{bg:green}].svg"
        style="width: 100%"
    />
</section>
<section>
    <h2><span class="zf-color">Client</span> consumes <span class="php-color">RealSubject</span></h2>
</section>

<section data-state="soothe">
    <img
        alt="A Client uses the RealSubject"
        src="http://yuml.me/diagram/dir:TB;scale:120;/class/[<<SubjectInterface>>]^-.-implements [RealSubject{bg:blue}], [RealSubject{bg:blue}]<-.-consumes [Client{bg:green}].svg"
        style="width: 100%"
    />
</section>
<section>
    <h2><span class="zf-color">Client</span> consumes <span class="proxy-color">SubjectProxy</span></h2>
</section>

<section data-state="soothe">
    <img
        alt="A Client uses the SubjectProxy"
        src="http://yuml.me/diagram/dir:TB;scale:180;/class/[<<SubjectInterface>>]^-.-implements [SubjectProxy{bg:orange}], [SubjectProxy{bg:orange}]<-.-consumes [Client{bg:green}].svg"
        style="width: 100%"
    />
</section>

<section>
    <h2>Simplified:</h2>
    <p>
        <span class="proxy-color">SubjectProxy</span> extending <span class="php-color">RealSubject</span>
    </p>
</section>

<section>
    <pre><code contenteditable>class SubjectProxy extends RealSubject { /* ... */ }</code></pre>
    <p>
        <img
            alt="ProxySubject extends the RealSubject"
            src="http://yuml.me/diagram/dir:TB;scale:160;/class/[RealSubject{bg:blue}]^-extends [SubjectProxy{bg:orange}].svg"
            style="width: 100%"
        />
    </p>

    <p class="fragment" style="font-size: small;">Though you <strong>should</strong> use interfaces!</p>
</section>

<section>
    <img
        alt="So what? I have a tie"
        src="assets/img/so-what-i-have-a-tie.jpg"
    />
</section>

<section>
    <h2>What do <span class="proxy-color">Proxies</span> do?</h2>
</section>

<section>
    <p>Some definitions here:</p>
    <img src="assets/img/POEAA.jpg" alt="PoEAA"/>
</section>

<section>
    <p>And here:</p>
    <img
        src="assets/img/Design-Patterns-Elements-of-Reusable-Object-Oriented-Software.jpg"
        alt="Design Patterns Elements of Reusable Object Oriented Software"
    />
</section>

<section>
    <p>And a lot of confusion over the internets :(</p>
</section>

<section>
    <h1>From the <abbr title="Gang of Four">GoF</abbr></h1>
</section>

<section>
    <h2>
        <span class="proxy-color">Remote proxy</span>
    </h2>
    <h2 class="fragment">
        <span class="proxy-color">Virtual proxy</span>
    </h2>
    <h2 class="fragment">
        <span class="proxy-color">Protection proxy</span>
    </h2>
    <h2 class="fragment">
        <span class="proxy-color">Smart reference</span>
    </h2>
</section>

<section>
    <h2>I'm a software architect</h2>
    <img
        class="fragment"
        src="assets/img/i-have-no-idea-what-i-m-doing.png" alt="I have no idea what I'm doing"
        style="width: 80%;"
    />
</section>

<section>
    <h2>Let's get practical!</h2>
</section>

<section>
    <h2><span class="proxy-color">Remote Proxy</span></h2>
</section>

<section data-state="soothe">
    <img
        alt="Remote Object Proxy UML"
        src="http://yuml.me/diagram/plain;dir:LR;scale:140;/class/[RealSubject{bg:blue}]intertubes-intertubes[SubjectProxy{bg:orange}].svg"
        style="width: 100%;"
    />
</section>

<section data-state="soothe">
    <img
        alt="Remote Object Proxy UML"
        src="http://yuml.me/diagram/plain;dir:LR;scale:180;/class/[RealSubject{bg:blue}]<-.- uses[AdapterServer{bg:green}],[AdapterServer{bg:green}]intertubes-intertubes[AdapterClient{bg:green}],[AdapterClient{bg:green}]<-.- uses[SubjectProxy{bg:orange}].svg"
        style="width: 100%;"
    />
</section>

<section>
    <h2><span class="proxy-color">Remote Object</span> example</h2>
</section>

<section>
    <pre><code contenteditable>class Tweet {
    protected $data;

    public function __construct(array $data) {
        $this->data = $data;
    }

    public function getText() {
        return $this->data['text'];
    }
}</code></pre>
</section>

<section>
    <pre><code contenteditable>class TweetProxy extends Tweet {
    protected $api;
    protected $id;

    public function __construct(TwitterApi $api, $id) {
        $this->api = $api;
        $this->id  = $id;
    }

    public function getText() {
        return $this->api->getTweetText($this->id);
    }
}</code></pre>
</section>

<section>
    <pre><code contenteditable>$tweet = new Tweet(array('text' => 'Proxies in PHP!'));
var_dump($tweet->getText()); // Proxies in PHP!

$api = new TwitterApi(/* yadda */);

$remoteTweet = new TweetProxy($api, 280643708968386560);
var_dump($remoteTweet->getText()); // Tweet text!

$remoteTweet = new TweetProxy($api, 280643708968386561);
var_dump($remoteTweet->getText()); // Another text!</code></pre>
</section>

<section>
    <h2><span class="proxy-color">remote object</span> pros/cons</h2>
    <p class="fragment pros-line">Share objects across multiple systems</p>
    <p class="fragment pros-line">No local memory usage</p>
    <p class="fragment pros-line">Can act as an adapter for a completely different remote object</p>
    <p class="fragment cons-line">Complex setup</p>
    <p class="fragment cons-line">Fails on adapter failure</p>
    <p class="fragment cons-line">As slow as the protocol</p>
</section>

<section>
    <h2><span class="php-color">Lazy Loading</span></h2>

    <img src="assets/img/lazy-loading.png" alt="Lazy Loading"/>
</section>

<section>
    <p>For <strong>very expensive</strong> objects:</p>
    <ul class="fragment">
        <li>DB Connections</li>
        <li>Files (I/O in general)</li>
        <li>Large objects (memory)</li>
        <li>Objects with long instantiation time (hashes/parsed values/etc)</li>
    </ul>
    <p class="fragment">(A pattern, not a proxy type)</p>
</section>
<section>
    <h2><span class="php-color">Lazy Loading</span> example</h2>
</section>
<section>
    <pre><code contenteditable>class Customer {
    public function __construct(DbConnection $db, $id) {
        $this->db = $db;
        $this->id = $id;
    }

    public function getName() {
        $this->init();
        return $this->data['name'];
    }

    private function init() {
        if (!isset($this->data)) {
            $this->data = $this->db->load($this->id);
        }
    }
}</code></pre>

</section>
<section>
    <h2>Problems with <span class="php-color">Lazy Loading</span></h2>

    <p class="fragment cons-line">Instantiation logic mixed with class logic</p>
    <p class="fragment cons-line">Dependency to loader objects in the object</p>
    <p class="fragment cons-line">Not really optimized, and unreadable if optimized</p>
    <p class="fragment cons-line">Harder to test</p>
</section>
<section>
    <h2><span class="php-color">Lazy loading</span> via <span class="proxy-color">Proxies</span></h2>

    <p class="fragment">
        <span class="proxy-color">Virtual Proxy</span>
        <br/>
        An object that looks like the <span class="php-color">RealSubject</span>, but just holds a lazy reference to it.
    </p>
    <p class="fragment">
        <span class="proxy-color">Ghost Object</span>
        <br/>
        An object that looks like the <span class="php-color">RealSubject</span>, but with all properties not being
        set and being lazy loaded.
    </p>
    <!--
    <p class="fragment">
        (not a proxy) <span class="php-color">Value holder</span>
        <br/>
        An abstraction of <span class="php-color">Lazy Loading</span>. It usually is an object that returns the
        lazy-loaded instance on demand.
    </p>
    -->
</section>

<section>
    <h2><span class="proxy-color">Virtual Proxy</span></h2>
</section>

<section>
    <pre><code contenteditable>class Image {
    protected $image;
    public function __construct($path) {
        $this->image = imagecreatefromjpeg($path);
    }

    public function getSize() {
        return array(
            imagesx($this->image),
            imagesy($this->image),
        );
    }
}</code></pre>
</section>

<section>
    <pre><code contenteditable>class ImageVirtualProxy extends Image {
    protected $wrapped;
    public function __construct($path) {
        $this->path = $path;
    }

    public function getSize() {
        $this->init();
        return $this->wrapped->getSize();
    }

    private function init() {
        if ( ! $this->wrapped) {
            $this->wrapped = new Image($this->path);
        }
    }
}</code></pre>
</section>

<section>
    <pre><code contenteditable>$img1 = new ImageProxy('/path/to/image1.jpg');
var_dump(memory_get_usage()); // ~200Kb
$img2 = new ImageProxy('/path/to/image2.jpg');
var_dump(memory_get_usage()); // ~200Kb
$img3 = new ImageProxy('/path/to/image3.jpg');
var_dump(memory_get_usage()); // ~200Kb

$size1 = $img1->getSize();
var_dump(memory_get_usage()); // ~4Mb
$size2 = $img2->getSize();
var_dump(memory_get_usage()); // ~8Mb</code></pre>
</section>

<section>
    <h2><span class="proxy-color">Virtual Proxy</span> pros/cons</h2>
    <p class="fragment pros-line">Abstracts initialization logic away</p>
    <p class="fragment pros-line">Improved memory/performance impact</p>
    <p class="fragment pros-line">Low overhead</p>
    <p class="fragment pros-line">Easy to implement</p>
    <p class="fragment cons-line">Not optimal for data that is always loaded</p>
    <p class="fragment cons-line">Lazy loading means lazy failing</p>
    <p class="fragment cons-line">Actually, not the same object as <span class="php-color">RealSubject</span> (different identity)</p>
</section>

<section>
    <h2><span class="proxy-color">Ghost Object</span></h2>
    <p class="fragment">
        An object whose properties are the same of the proxied object, but <code>null</code>.
    </p>
    <p class="fragment">
        Accessing any method causes loading of the properties.
    </p>
    <p class="fragment">Useful when the identity of the object has to be preserved</p>
    <p class="fragment">
        <a class="doctrine-color" href="https://github.com/doctrine/common/tree/master/lib/Doctrine/Common/Proxy" target="_blank">Doctrine Proxies</a>
        are <a class="php-color" href="https://gist.github.com/4038004" target="_blank">generated</a> this way.
    </p>
</section>

<section>
    <h2><span class="proxy-color">Ghost Object</span> (simplified) example</h2>
</section>
<section>
    <pre><code contenteditable>class ImageGhostProxy extends Image {
    protected $initialized = false;
    public function __construct($path) {
        $this->path = $path;
    }
    public function getSize() {
        $this->init();
        return parent::getSize();
    }
    private function init() {
        if ( ! $this->initialized) {
            $image             = new Image($this->path);
            $this->image       = $image->image;
            $this->initialized = true;
        }
    }
}</code></pre>
</section>

<section>
    <h2><span class="proxy-color">Ghost Object</span> pros/cons</h2>
    <p class="fragment pros-line">Same identity as <span class="php-color">RealSubject</span></p>
    <p class="fragment pros-line">Abstracts initialization logic away</p>
    <p class="fragment pros-line">Improved memory/performance impact</p>
    <p class="fragment pros-line">Low overhead</p>
    <p class="fragment cons-line">Harder to implement</p>
    <p class="fragment cons-line">May require reflection to access parent class's properties</p>
    <p class="fragment cons-line">Not optimal for data that is always loaded</p>
    <p class="fragment cons-line">Lazy loading means lazy failing</p>
</section>

<!-- @todo re-introduce example with weakref? -->
<!-- @todo re-introduce example with null object? -->

<section>
    <h2><span class="proxy-color">Protection proxy</span></h2>
    <p class="fragment">
        A <span class="proxy-color">Protection Proxy</span> comes into play when you want to transparently
        limit access to an API through a set of rules (ACL/limits/custom logic).
    </p>
    <p class="fragment">It actually is a decorator to the proxied <span class="php-color">RealSubject</span>.</p>
</section>

<section>
    <pre><code contenteditable>class APIProtectionProxy extends API {
    protected $count = 0;
    public function __construct(API $api, $limit) {
        $this->api = $api; $this->limit = $limit;
    }

    public function doStuff() {
        $this->count();
        return $this->api->doStuff();
    }

    private function count() {
        if (++$this->count > $this->limit) {
            throw new RemoteApiLimit('STAHP!');
        }
    }
}</code></pre>
</section>

<section>
    <pre><code contenteditable>$api = new APIProtectionProxy(new API(/* ... */), 50);

while (true) {
    $api->doStuff(); // RemoteApiLimit exception!
}</code></pre>
</section>

<section>
    <h2><span class="proxy-color">Protection Proxy</span> pros/cons</h2>
    <p class="fragment pros-line">Limiting access to an API does not require changes in the API</p>
    <p class="fragment cons-line">Modifies proxied object behavior</p>
</section>

<section>
    <h2><span class="proxy-color">Smart reference</span></h2>
    <p class="fragment">
        A <span class="proxy-color">Smart reference</span> executes additional operations when the
        <span class="">RealSubject</span> is accessed
    </p>
    <p class="fragment">
        Smart reference is actually <span class="php-color">DecoratorPattern</span>
    </p>
    <p class="fragment">Good for <span class="php-color">AOP</span></p>
</section>
<section>
    <h2><span class="proxy-color">Smart reference</span> use cases</h2>
    <ul>
        <li class="fragment">Caching slow method execution</li>
        <li class="fragment">Logging</li>
        <li class="fragment">Event triggering</li>
        <li class="fragment">Mocking</li>
        <li class="fragment"><abbr title="Aspect Oriented Programming">AOP</abbr> in general</li>
    </ul>
</section>

<section>
    <h2><span class="proxy-color">Smart reference</span> example</h2>
    <p class="fragment">Let's cache a complex/slow method call</p>
</section>

<section>
    <pre class="fragment"><code contenteditable>    /**
     * @AOP\Cache(ttl=3600)
     */
    public function doHeavyStuff() {
        // [...]
    }</code></pre>
    <p class="fragment">Could become:</p>
    <pre class="fragment"><code contenteditable>class APICachingProxy extends API {
    public function __construct(API $api, Cache $cache) {
        $this->api = $api; $this->cache = $cache;
    }

    public function doHeavyStuff() {
        if ($cached = $this->cache->get('doHeavyStuff')) {
            return $cached;
        }

        $result = $this->api->doHeavyStuff();

        $this->cache->set('doHeavyStuff', $result, 3600);

        return $result;
    }
}</code></pre>
</section>

<section>
    <h2>Implementing a <span>Proxy</span> in <span class="php-color">PHP</span></h2>
</section>

<section>
    <h2>Poor coder's <span class="proxy-color">proxy</span> implementation:</h2>
    <pre class="fragment"><code contenteditable>class MyProxy {
    // ...

    public function __call($method, $args) {
        return call_user_func_array(
            $this->someWrappedStuff,
            $args
        );
    }
}</code></pre>
</section>

<section>
    <img src="assets/img/nooooo-darth-vader.jpg" alt="don't do it!"/>
</section>

<section>
    <h2>Implementing a (generic) <span class="proxy-color">Proxy</span></h2>
    <ol>
        <li><span class="php-color">MUST</span> respect the LSP!</li>
        <li>Not so trivial!</li>
    </ol>
</section>

<section>
    <h2><span class="proxy-color">Proxies</span> are NOT nice:</h2>
    <pre><code contenteditable>&lt;?php
namespace Proxy\__PM__;

class A extends \A
{
    private $valueHolder;
    private $initializer;

    public function getFoo()
    {
        $this->initializer && $this->initializer->__invoke($this->valueHolder, $this, 'getFoo', array(), $this->initializer);

        return $this->valueHolder->getFoo();
    }

    public function __construct($initializer)
    {
        unset($this->foo);

        $this->initializer = $initializer;
    }

    public function __get($name)
    {
        $this->initializer && $this->initializer->__invoke($this->valueHolder, $this, '__get', array('name' => $name), $this->initializer);

        return $this->valueHolder->$name;
    }

    public function __set($name, $value)
    {
        $this->initializer && $this->initializer->__invoke($this->valueHolder, $this, '__set', array('name' => $name, 'value' => $value), $this->initializer);

        $this->valueHolder->$name = $value;
    }

    public function __isset($name)
    {
        $this->initializer && $this->initializer->__invoke($this->valueHolder, $this, '__isset', array('name' => $name), $this->initializer);

        return isset($this->valueHolder->$name);
    }

    public function __unset($name)
    {
        $this->initializer && $this->initializer->__invoke($this->valueHolder, $this, '__unset', array('name' => $name), $this->initializer);

        unset($this->valueHolder->$name);
    }

    public function __clone()
    {
        $this->initializer && $this->initializer->__invoke($this->valueHolder, $this, '__clone', array(), $this->initializer);

        $this->valueHolder = clone $this->valueHolder;
    }

    public function __sleep()
    {
        $this->initializer && $this->initializer->__invoke($this->valueHolder, $this, '__sleep', array(), $this->initializer);

        return array('valueHolder');
    }

    public function __wakeup()
    {
        unset($this->foo);
    }

    public function setProxyInitializer(\Closure $initializer = null)
    {
        $this->initializer = $initializer;
    }

    public function getProxyInitializer()
    {
        return $this->initializer;
    }

    public function initializeProxy()
    {
        return $this->initializer && $this->initializer->__invoke($this->valueHolder, $this, 'initializeProxy', array(), $this->initializer);
    }

    public function isProxyInitialized()
    {
        return null !== $this->valueHolder;
    }

    public function getWrappedValueHolderValue()
        {
        return $this->valueHolder;
    }
}</code></pre>
</section>

<section>
    <h2>Introducing <span class="proxy-color">ProxyManager</span></h2>
    <p>
        <img
            src="assets/img/gh.svg"
            alt="ProxyManager on Github"
            height="40px"
            style="margin: 0;"
        />
        <a href="https://github.com/Ocramius/ProxyManager" target="_blank">https://github.com/Ocramius/ProxyManager</a>
    </p>
</section>

<section>
    <p>Avoid bringing out the generated garbage yourself!</p>
    <p>
        (Currently) deals with
        <span class="proxy-color">Virtual Proxy</span>,
        <span class="proxy-color">Smart Reference</span> and
        <span class="proxy-color">Ghost Objects</span>
    </p>
</section>

<section>
    <p>Integrated in <span class="php-color">Symfony2</span> and <span class="zf-color">Zend Framework 2</span></p>
</section>

<section>
    <h2><span class="php-color">Virtual Proxy</span> with <span class="proxy-color">ProxyManager</span></h2>
</section>
<section>
    <pre><code contenteditable>namespace My\Slow;

class Foo
{
    public function __construct()
    {
        sleep(10);
    }

    public function doFoo()
    {
        echo 'foo!';
    }
}</code></pre>

</section>

<section>
    <pre><code contenteditable>require_once 'vendor/autoload.php';
use ProxyManager\Factory\LazyLoadingValueHolderFactory;

$config  = new ProxyManager\Configuration();
$factory = new LazyLoadingValueHolderFactory($config);

$proxy = $factory->createProxy(
    'My\Slow\Foo',
    function (& $wrappedObject, $proxy) {
        $wrappedObject = new My\Slow\Foo();
        $proxy->setProxyInitializer(null);
    }
);

$proxy->doFoo();</code></pre>
</section>

<section>
    <h2><span class="php-color">Smart Reference</span> with <span class="proxy-color">ProxyManager</span></h2>
</section>
<section>
    <pre><code contenteditable>require_once 'vendor/autoload.php';
use ProxyManager\Factory\AccessInterceptorValueHolderFactory;

$config  = new ProxyManager\Configuration();
$factory = new AccessInterceptorValueHolderFactory($config);
$db = $factory->createProxy(
    new \My\Db\Connection(),
    array('query' => function () {
        echo "Query being executed!\n";
    }),
    array('query' => function () {
        echo "Query completed!\n";
    })
);

$db->query();</code></pre>
    <p class="fragment">Yes, I'm no good at naming classes - really.</p>
</section>

<section>
    <h2><span class="proxy-color">Virtual Proxies</span> + <span class="zf-color">Zend Framework 2</span></h2>
    <pre><code contenteditable>return [
    'service_manager' =&gt; [
        'delegators' =&gt; [
            'MyServiceName' =&gt; ['LazyServiceFactory']
        ],
    ],
    'lazy_services' =&gt; [
        'map' =&gt; ['MyServiceName' =&gt; 'My\Service\ClassName']
    ]
]</code></pre>
</section>

<section>
        <h2><span class="proxy-color">Virtual Proxies</span> + <span class="php-color">Symfony 2</span></h2>
<pre><code contenteditable>&lt;services&gt;
    &lt;service
        id="MyServiceName"
        class="My\Service\ClassName"
        lazy="true"
    /&gt;
&lt;/services&gt;</code></pre>
</section>

<section>
    <h2>Some useful libraries</h2>
    <p class="fragment">
        <a href="https://github.com/doctrine/common/blob/master/lib/Doctrine/Common/Proxy/ProxyGenerator.php">
            Doctrine's Proxy Generator
        </a>
    </p>
    <p class="fragment">
        <a href="https://github.com/ocramius/ProxyManager">ProxyManager</a>
    </p>
    <p class="fragment"><a href="http://flow.typo3.org/" target="_blank">Flow (Typo3)</a></p>
    <p class="fragment">
        <a href="https://github.com/schmittjoh/cg-library/" target="_blank">schmittjoh/cg-library</a>
    </p>
</section>
<section>
    <h2><span class="proxy-color">Proxies</span> and <span class="php-color">AOP</span></h2>
    <p>
        <img
            src="assets/img/gh.svg"
            alt="Ocramius on Github"
            height="40px"
            style="margin: 0;"
        />
        <a href="https://github.com/lisachenko/go-aop-php/" target="_blank">lisachenko/go-aop-php</a>
    </p>
    <p>
        Uses <span class="proxy-color">proxies</span> for <span class="php-color">AOP</span> purposes
    </p>
    <p>
        Very interesting usage of <span class="php-color">autoloaders</span>!
    </p>
</section>

<section>
    <h2>Questions?</h2>
</section>

<section>
    <h2>Thank you!</h2>
    <p>
	    Slides at 
	    <a href="http://marco-pivetta.com/proxy-pattern-in-php/" target="_blank">
		    marco-pivetta.com/proxy-pattern-in-php/
	    </a>
	</p>
    <p>
        Fork the slides!
        <br/>
        <img
            src="assets/img/gh.svg"
            alt="Ocramius on Github"
            height="40px"
            style="margin: 0;"
        />
        <a href="https://github.com/Ocramius/proxy-pattern-in-php" target="_blank">
            Ocramius/proxy-pattern-in-php
        </a>
    </p>
    <p>
        <img
            src="assets/img/twitter.svg"
            alt="Ocramius on Twitter"
            height="30px"
            style="margin: 0;"
        />
        <img
            src="assets/img/gh.svg"
            alt="Ocramius on Github"
            height="40px"
            style="margin: 0;"
        />
        <a href="http://github.com/Ocramius" target="_blank">Ocramius</a>
    </p>
</section>


<section>
    <h2><span class="php-color">Public properties</span> <span class="proxy-color">proxying</span></h2>
    <pre class="fragment"><code contenteditable>class Customer {
    public $name;
    public $surname;
}</code></pre>

    <pre class="fragment"><code contenteditable>class CustomerProxy extends Customer {
    public function __construct(Customer $customer) {
        unset($this->name, $this->surname);
        $this->customer = $customer;
    }</code></pre>
	
    <pre class="fragment"><code contenteditable>    public function __set($name, $value) {
        $this->customer->$name = $value;
    }

    public function __get($name) {
        return $this->customer->$name;
    }
    // __isset, __unset, __clone, __sleep, __wakeup (or serialize/unserialize)
}</code></pre>
</section>


</div>
</div>

<script src="bower_components/reveal.js/lib/js/head.min.js"></script>
<script src="bower_components/reveal.js/js/reveal.min.js"></script>
<script>
    // Configure Reveal
    // Full list of configuration options available here:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        theme: Reveal.getQueryHash().theme || 'sky', // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'none', // default/cube/page/concave/zoom/linear/fade/none

        // Optional libraries used to extend on reveal.js
        dependencies: [
            { src: 'bower_components/reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
            { src: 'bower_components/reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
            { src: 'bower_components/reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
            { src: 'bower_components/reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
            { src: 'bower_components/reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
            { src: 'bower_components/reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } },
            // { src: 'plugin/search/search.js', async: true, condition: function() { return !!document.body.classList; } }
            //{ src: 'bower_components/reveal.js/plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }

            { src: 'js/loadhtmlslides.js', condition: function() { return !!document.querySelector( '[data-html]' ); } }
        ]
    });
</script>

<script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-15310667-1']);
    _gaq.push(['_setDomainName', 'marco-pivetta.com']);
    _gaq.push(['_trackPageview']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

</script>

</body>
</html>
